<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Download de NFE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-responsive {
            margin-top: 20px;
        }
        .status-cell {
            min-width: 200px;
        }
        .key-cell {
            font-family: monospace;
        }
        .loading {
            display: inline-block;
            margin-right: 5px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .url-button {
            display: none;
        }
        .cached {
            color: #0d6efd;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .progress {
            height: 20px;
            margin-bottom: 10px;
        }
        .batch-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #downloadProgress {
            flex-grow: 1;
        }
        .status-message {
            margin-top: 5px;
            font-size: 0.9em;
        }
        /* CNPJ Group Styling */
        .cnpj-group-header {
            background-color: #e9ecef;
            font-weight: bold;
            cursor: pointer;
        }
        .cnpj-group-header:hover {
            background-color: #dee2e6;
        }
        .cnpj-group-header td {
            padding: 10px 15px;
        }
        .cnpj-group-hidden {
            display: none;
        }
        .cnpj-toggle-icon {
            margin-right: 8px;
            transition: transform 0.2s;
        }
        .cnpj-toggle-icon.open {
            transform: rotate(90deg);
        }
        .cnpj-cell {
            font-family: monospace;
        }
        .ano-mes-cell {
            font-weight: 500;
            color: #666;
        }
        .uf-cell {
            font-weight: 600;
            color: #444;
        }
        .numero-cell {
            font-family: monospace;
            color: #555;
        }
        .table th {
            white-space: nowrap;
        }
        .table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Sistema de Download de NFE</h1>
            <a href="/" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Voltar para o inicio
            </a>
        </div>

        <!-- Alerta sobre Certificado Digital -->
        <div class="alert alert-warning mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-certificate fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Atenção ao Certificado Digital!</h5>
                    <p class="mb-0">Para baixar XMLs de NFe de <strong>diferentes clientes</strong>, você precisa <strong>fechar esta página</strong> e abri-la novamente para permitir a seleção do certificado digital correspondente. Certifique-se de que os certificados digitais de todos os seus clientes estejam instalados no computador.</p>
                </div>
            </div>
            <div class="mt-2">
                <small class="d-block text-muted">
                    <i class="fas fa-info-circle me-1"></i> Dica: A seleção de certificados pode variar dependendo do navegador. No Chrome e Edge, a seleção aparece no início da sessão. No Firefox, pode aparecer a cada operação.
                </small>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <!-- NFe Key Input Form -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Adicionar Chaves NFe</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-3" id="keyInputTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="single-key-tab" data-bs-toggle="tab" data-bs-target="#single-key" type="button" role="tab" aria-controls="single-key" aria-selected="true">Chave Única</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="multiple-keys-tab" data-bs-toggle="tab" data-bs-target="#multiple-keys" type="button" role="tab" aria-controls="multiple-keys" aria-selected="false">Múltiplas Chaves</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="keyInputTabsContent">
                            <!-- Single Key Input -->
                            <div class="tab-pane fade show active" id="single-key" role="tabpanel" aria-labelledby="single-key-tab">
                                <form id="singleKeyForm" class="row g-3">
                                    <div class="col-md-8">
                                        <label for="nfeKeyInput" class="form-label">Chave da NFe (44 dígitos)</label>
                                        <input type="text" class="form-control" id="nfeKeyInput" placeholder="Digite a chave NFe" maxlength="44" pattern="[0-9]{44}" required>
                                        <div class="form-text">Exemplo: 51250209608375000103550010000047211000141634</div>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary mb-3">
                                            <i class="fas fa-plus-circle me-2"></i>Adicionar Chave
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <!-- Multiple Keys Input -->
                            <div class="tab-pane fade" id="multiple-keys" role="tabpanel" aria-labelledby="multiple-keys-tab">
                                <form id="multipleKeysForm">
                                    <div class="mb-3">
                                        <label for="nfeKeysTextarea" class="form-label">Múltiplas Chaves NFe</label>
                                        <textarea class="form-control" id="nfeKeysTextarea" rows="5" placeholder="Cole uma chave por linha (44 dígitos cada)" required></textarea>
                                        <div class="form-text">Cole uma chave NFe por linha. Todas as chaves devem ter 44 dígitos.</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus-circle me-2"></i>Adicionar Todas as Chaves
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="batch-controls">
                    <button class="btn btn-primary" onclick="downloadAll()" id="downloadAllBtn">
                        <i class="fas fa-download"></i> Baixar Todos os XMLs
                    </button>
                    <button class="btn btn-success" onclick="openAllUrls()" id="openAllUrlsBtn">
                        <i class="fas fa-external-link-alt"></i> Abrir Todas as URLs
                    </button>
                    <button class="btn btn-warning" onclick="clearCache()" id="clearCacheBtn">
                        <i class="fas fa-trash"></i> Limpar Cache
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllKeys()" id="deleteAllBtn">
                        <i class="fas fa-trash-alt"></i> Remover Todas as Chaves
                    </button>
                    <button class="btn btn-info" onclick="organizeKeysByCNPJ()" id="regroupBtn">
                        <i class="fas fa-layer-group"></i> Reagrupar por CNPJ
                    </button>
                    <div class="progress" id="downloadProgress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <button class="btn btn-danger" onclick="cancelDownloads()" id="cancelBtn" style="display: none;">
                        <i class="fas fa-stop"></i> Cancelar
                    </button>
                </div>

                <div class="d-flex mb-3 align-items-center">
                    <div class="input-group me-3" style="max-width: 300px;">
                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                        <select class="form-select" id="cnpjFilter">
                            <option value="">Todos os CNPJs</option>
                            {% set cnpjs = [] %}
                            {% for key in keys %}
                                {% if key[6:20] not in cnpjs %}
                                    {% set _ = cnpjs.append(key[6:20]) %}
                                    <option value="{{ key[6:20] }}">{{ key[6:20] }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearCNPJFilter()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="input-group me-3" style="max-width: 200px;">
                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                        <select class="form-select" id="dateFilter">
                            <option value="">Todos os Períodos</option>
                            {% set periodos = [] %}
                            {% for key in keys %}
                                {% set periodo = "20" + key[2:4] + "/" + key[4:6] %}
                                {% if periodo not in periodos %}
                                    {% set _ = periodos.append(periodo) %}
                                    <option value="{{ periodo }}">{{ periodo }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearDateFilter()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="input-group me-3" style="max-width: 280px;">
                        <span class="input-group-text" data-bs-toggle="tooltip" title="Ajuste a quantidade de processamentos simultâneos para otimizar o desempenho de acordo com a capacidade do seu computador e conexão.">
                            <i class="fas fa-tasks"></i>
                        </span>
                        <select class="form-select" id="concurrencyLimit" aria-label="Limite de processamento simultâneo">
                            <option value="2">2 chaves simultâneas</option>
                            <option value="5">5 chaves simultâneas</option>
                            <option value="10" selected>10 chaves simultâneas</option>
                            <option value="15">15 chaves simultâneas</option>
                            <option value="20">20 chaves simultâneas</option>
                            <option value="30">30 chaves simultâneas</option>
                            <option value="50">50 chaves simultâneas</option>
                            <option value="80">80 chaves simultâneas</option>
                            <option value="100">100 chaves simultâneas</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="popover" data-bs-placement="bottom" 
                                title="Ajuste de Concorrência" 
                                data-bs-content="Aumentar o número de chaves processadas simultaneamente pode acelerar o download, mas também pode sobrecarregar sua conexão ou computador. Ajuste de acordo com seu ambiente.">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                    <div class="ms-auto">
                        <span class="text-muted me-2">Total: <span id="totalKeysCount">0</span> chaves</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="expandAllGroups()">
                                <i class="fas fa-expand-alt"></i> Expandir
                            </button>
                            <button class="btn btn-outline-secondary" onclick="collapseAllGroups()">
                                <i class="fas fa-compress-alt"></i> Recolher
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>Ano/Mês</th>
                                <th>UF</th>
                                <th>Número NF</th>
                                <th>Chave NFE</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="nfe-keys-table">
                            {% for key in keys %}
                            <tr data-cnpj="{{ key[6:20] }}" class="key-row">
                                <td class="cnpj-cell">{{ key[6:20]|default('N/A') }}</td>
                                <td class="ano-mes-cell">{{ "20" + key[2:4] + "/" + key[4:6] }}</td>
                                <td class="uf-cell">{{ key[0:2] }}</td>
                                <td class="numero-cell">{{ key[25:34] }}</td>
                                <td class="key-cell">{{ key }}</td>
                                <td class="status-cell" id="status-{{ key }}">
                                    {% if key in cache %}
                                    <span class="text-success">
                                        <i class="fas fa-check"></i> Download disponível
                                        <span class="cached"><i class="fas fa-clock"></i> Em cache</span>
                                    </span>
                                    {% else %}
                                    <span class="text-muted">Aguardando processamento</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary btn-sm download-btn" 
                                                onclick="processNFE('{{ key }}')"
                                                id="btn-{{ key }}">
                                            <i class="fas fa-download"></i> Baixar XML
                                        </button>
                                        <a href="{% if key in cache %}{{ cache[key]['url'] }}{% else %}#{% endif %}" 
                                           class="btn btn-success btn-sm url-button" 
                                           id="url-btn-{{ key }}" 
                                           target="_blank"
                                           style="display: {% if key in cache %}inline-block{% else %}none{% endif %}">
                                            <i class="fas fa-external-link-alt"></i> Abrir URL
                                        </a>
                                        <button class="btn btn-danger btn-sm" 
                                                onclick="deleteKey('{{ key }}')"
                                                id="delete-btn-{{ key }}">
                                            <i class="fas fa-trash"></i> Remover
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cache local
        const urlCache = new Map();
        let isDownloading = false;
        let shouldCancelDownloads = false;

        // Inicializa o cache com dados do servidor
        {% for key, data in cache.items() %}
        urlCache.set('{{ key }}', '{{ data.url }}');
        {% endfor %}

        // Inicializa os status de processamento
        document.addEventListener('DOMContentLoaded', function() {
            organizeKeysByCNPJ();
            
            // Restaura os status de processamento do servidor
            {% for key, data in processing.items() %}
            updateStatus('{{ key }}', '<i class="fas fa-spinner fa-spin"></i> Obtendo URL...', false);
            {% endfor %}
            
            // Add event listener for CNPJ filter
            document.getElementById('cnpjFilter').addEventListener('change', filterKeys);
            
            // Add event listener for date filter
            document.getElementById('dateFilter').addEventListener('change', filterKeys);
            
            // Restaura a configuração de concorrência salva
            const savedConcurrency = localStorage.getItem('concurrencyLimit');
            if (savedConcurrency) {
                document.getElementById('concurrencyLimit').value = savedConcurrency;
            }
            
            // Adiciona listener para salvar a configuração quando alterada
            document.getElementById('concurrencyLimit').addEventListener('change', function() {
                localStorage.setItem('concurrencyLimit', this.value);
                
                // Exibe mensagem de confirmação temporária
                const currentValue = parseInt(this.value, 10);
                updateGlobalStatus(`Configuração atualizada: ${currentValue} chaves serão processadas simultaneamente`, 'info');
            });
            
            // Inicializa tooltips e popovers do Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });
        });

        // Function to organize keys by CNPJ
        function organizeKeysByCNPJ() {
            const table = document.getElementById('nfe-keys-table');
            const rows = Array.from(table.querySelectorAll('tr.key-row'));
            
            if (rows.length === 0) return;
            
            // Update total keys count
            document.getElementById('totalKeysCount').textContent = rows.length;
            
            // Remove all rows from the table
            rows.forEach(row => row.remove());
            
            // Group rows by CNPJ
            const cnpjGroups = {};
            rows.forEach(row => {
                const cnpj = row.getAttribute('data-cnpj');
                if (!cnpjGroups[cnpj]) {
                    cnpjGroups[cnpj] = [];
                }
                cnpjGroups[cnpj].push(row);
            });
            
            // Add grouped rows back to the table
            Object.keys(cnpjGroups).sort().forEach(cnpj => {
                const formattedCNPJ = formatCNPJ(cnpj);
                const groupCount = cnpjGroups[cnpj].length;
                
                // Create group header
                const headerRow = document.createElement('tr');
                headerRow.className = 'cnpj-group-header';
                headerRow.setAttribute('data-cnpj', cnpj);
                headerRow.innerHTML = `
                    <td colspan="7">
                        <i class="fas fa-caret-right cnpj-toggle-icon"></i>
                        CNPJ: <span class="cnpj-formatted">${formattedCNPJ}</span>
                        <span class="badge bg-primary ms-2">${groupCount} chave(s)</span>
                    </td>
                `;
                
                // Add click event to toggle group visibility
                headerRow.addEventListener('click', function() {
                    const cnpj = this.getAttribute('data-cnpj');
                    const icon = this.querySelector('.cnpj-toggle-icon');
                    icon.classList.toggle('open');
                    
                    const groupRows = table.querySelectorAll(`tr.key-row[data-cnpj="${cnpj}"]`);
                    groupRows.forEach(row => {
                        row.classList.toggle('cnpj-group-hidden');
                    });
                });
                
                table.appendChild(headerRow);
                
                // Add group rows
                cnpjGroups[cnpj].forEach(row => {
                    // Hide rows by default
                    row.classList.add('cnpj-group-hidden');
                    table.appendChild(row);
                });
            });
        }

        // Function to validate NFe key format (44 digits)
        function isValidNfeKey(key) {
            return /^\d{44}$/.test(key);
        }
        
        // Function to extract CNPJ from NFe key (positions 7-20)
        function extractCNPJ(key) {
            if (!isValidNfeKey(key)) return 'CNPJ Inválido';
            return key.substring(6, 20);
        }
        
        // Function to format CNPJ with proper punctuation
        function formatCNPJ(cnpj) {
            return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }

        // Function to save a single key to the server
        async function saveSingleKeyToServer(key) {
            try {
                const response = await fetch('/save-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ key: key }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear input field after successful submission
                    document.getElementById('nfeKeyInput').value = '';
                    
                    if (data.already_exists) {
                        updateGlobalStatus(`A chave NFe ${key} já existe no sistema.`, 'warning');
                    } else {
                        updateGlobalStatus(`Chave NFe ${key} adicionada com sucesso.`, 'success');
                        
                        // Reload the page to show the new key
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                } else {
                    updateGlobalStatus(`Erro ao salvar chave NFe: ${data.message}`, 'danger');
                }
            } catch (error) {
                updateGlobalStatus(`Erro ao salvar chave NFe: ${error.message}`, 'danger');
            }
        }

        // Event listener for single key form submission
        document.getElementById('singleKeyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const keyInput = document.getElementById('nfeKeyInput');
            const key = keyInput.value.trim();
            
            if (!isValidNfeKey(key)) {
                updateGlobalStatus(`Chave NFe inválida: ${key}. A chave deve ter 44 dígitos numéricos.`, 'danger');
                return;
            }
            
            // Save key to server
            saveSingleKeyToServer(key);
        });
        
        // Event listener for multiple keys form submission
        document.getElementById('multipleKeysForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const keysTextarea = document.getElementById('nfeKeysTextarea');
            const keysText = keysTextarea.value.trim();
            
            if (!keysText) {
                updateGlobalStatus('Por favor, insira pelo menos uma chave NFe.', 'warning');
                return;
            }
            
            const keys = keysText.split('\n').map(k => k.trim()).filter(k => k);
            
            // Send all keys to server at once
            saveMultipleKeysToServer(keys);
        });
        
        // Function to save multiple keys to the server
        async function saveMultipleKeysToServer(keys) {
            try {
                updateGlobalStatus('Processando chaves...', 'info');
                
                const response = await fetch('/save-multiple-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ keys: keys }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear textarea after successful submission
                    document.getElementById('nfeKeysTextarea').value = '';
                    
                    // Create status message
                    let message = `${data.added_count} chaves adicionadas com sucesso.`;
                    if (data.existing_count > 0) {
                        message += ` ${data.existing_count} já existiam.`;
                    }
                    if (data.invalid_count > 0) {
                        message += ` ${data.invalid_count} chaves inválidas foram ignoradas.`;
                    }
                    
                    updateGlobalStatus(message, 'success');
                    
                    // Reload the page to show the new keys
                    if (data.added_count > 0) {
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                } else {
                    updateGlobalStatus(`Erro ao salvar chaves: ${data.message}`, 'danger');
                }
            } catch (error) {
                updateGlobalStatus(`Erro ao salvar chaves: ${error.message}`, 'danger');
            }
        }

        function updateGlobalStatus(message, type = 'success') {
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const statusSpan = document.createElement('span');
            statusSpan.className = `status-message text-${type}`;
            statusSpan.innerHTML = message;
            
            // Remove mensagem anterior se existir
            const oldStatus = downloadAllBtn.parentElement.querySelector('.status-message');
            if (oldStatus) {
                oldStatus.remove();
            }
            
            // Adiciona nova mensagem após o botão
            downloadAllBtn.parentElement.appendChild(statusSpan);
            
            // Remove a mensagem após 5 segundos
            setTimeout(() => statusSpan.remove(), 5000);
        }

        function updateStatus(key, message, isError = false, isCached = false) {
            const statusCell = document.getElementById(`status-${key}`);
            let statusHtml = `<span class="text-${isError ? 'danger' : 'success'}">${message}`;
            if (isCached) {
                statusHtml += `<span class="cached"><i class="fas fa-clock"></i> Em cache</span>`;
            }
            statusHtml += '</span>';
            statusCell.innerHTML = statusHtml;
        }

        function showUrlButton(key, url) {
            const urlButton = document.getElementById(`url-btn-${key}`);
            urlButton.href = url;
            urlButton.style.display = 'inline-block';
            
            // Atualiza o cache local
            urlCache.set(key, url);

            // Simula o clique no botão automaticamente
            window.open(url, '_blank');
        }

        function updateProgress(current, total) {
            const progress = document.querySelector('#downloadProgress .progress-bar');
            const percentage = Math.round((current / total) * 100);
            progress.style.width = `${percentage}%`;
            progress.setAttribute('aria-valuenow', percentage);
            progress.textContent = `${percentage}% (${current}/${total})`;
        }

        async function processNFEAsync(key) {
            const button = document.getElementById(`btn-${key}`);
            const urlButton = document.getElementById(`url-btn-${key}`);
            button.disabled = true;
            
            try {
                // Se já temos no cache, use diretamente
                if (urlCache.has(key)) {
                    const cachedUrl = urlCache.get(key);
                    updateStatus(key, '<i class="fas fa-check"></i> Download disponível', false, true);
                    showUrlButton(key, cachedUrl);
                    await fetch(`/download/${key}`);
                    button.disabled = false;
                    return true;
                }

                urlButton.style.display = 'none';
                updateStatus(key, '<i class="fas fa-spinner fa-spin"></i> Obtendo URL...', false);
                
                // Registra o status como processando no servidor
                await fetch('/set-processing-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: key,
                        status: 'processing',
                        message: 'Obtendo URL...'
                    })
                });

                const response = await fetch(`/get-url/${key}`);
                const data = await response.json();

                if (data.success) {
                    updateStatus(key, '<i class="fas fa-check"></i> Download disponível', false, data.from_cache);
                    showUrlButton(key, data.url);
                    await fetch(`/download/${key}`);
                    
                    // Registra o status como concluído no servidor
                    await fetch('/set-processing-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            key: key,
                            status: 'done',
                            message: 'Download disponível'
                        })
                    });
                    
                    button.disabled = false;
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus(key, `<i class="fas fa-exclamation-triangle"></i> ${error.message}`, true);
                
                // Registra o status como erro no servidor
                await fetch('/set-processing-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: key,
                        status: 'error',
                        message: error.message
                    })
                });
                
                button.disabled = false;
                urlButton.style.display = 'none';
                updateGlobalStatus(`Erro ao processar NFE ${key}: ${error.message}`, 'danger');
                return false;
            }
        }

        function processNFE(key) {
            processNFEAsync(key).then(success => {
                if (success) {
                    window.location.href = `/download/${key}`;
                }
            });
        }

        async function downloadAll(retryAttempt = 0, keysToProcess = null) {
            if (isDownloading) return;
            
            // Se não foram fornecidas chaves específicas, processa todas as pendentes
            const pendingKeys = keysToProcess || Array.from(document.querySelectorAll('.key-cell'))
                .filter(td => {
                    const key = td.textContent.trim();
                    const urlButton = document.getElementById(`url-btn-${key}`);
                    return urlButton.style.display === 'none';
                })
                .map(td => td.textContent.trim());

            if (pendingKeys.length === 0) {
                updateGlobalStatus('Não há chaves pendentes para processar', 'info');
                return;
            }

            // Obtém o limite de concorrência definido pelo usuário
            const concurrencyLimit = parseInt(document.getElementById('concurrencyLimit').value, 10) || 10;
            
            const totalKeys = pendingKeys.length;
            let successCount = 0;
            let failCount = 0;
            let processedCount = 0;
            
            // Armazena as chaves que falharam para possível novo processamento
            let failedKeys = [];

            isDownloading = true;
            shouldCancelDownloads = false;
            
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            downloadAllBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Processando...';
            
            document.getElementById('downloadProgress').style.display = 'flex';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            downloadAllBtn.disabled = true;

            while (processedCount < totalKeys && !shouldCancelDownloads) {
                const batch = pendingKeys.slice(processedCount, processedCount + concurrencyLimit);
                
                try {
                    const results = await Promise.all(
                        batch.map(async (key) => {
                            const success = await processNFEAsync(key);
                            if (!success) {
                                failedKeys.push(key);
                            }
                            return success;
                        })
                    );
                    
                    results.forEach(success => {
                        if (success) successCount++;
                        else failCount++;
                    });

                    processedCount += batch.length;
                    updateProgress(processedCount, totalKeys);

                } catch (error) {
                    console.error('Erro no processamento do lote:', error);
                }

                if (shouldCancelDownloads) {
                    updateGlobalStatus('Processamento cancelado pelo usuário', 'warning');
                    break;
                }
            }

            // Verifica se devemos fazer nova tentativa com as chaves que falharam
            if (failedKeys.length > 0 && !shouldCancelDownloads && retryAttempt < 3) {
                isDownloading = false;
                document.getElementById('downloadProgress').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'none';
                
                // Mensagem temporária sobre o reprocessamento
                updateGlobalStatus(`Reprocessando ${failedKeys.length} chave(s) com erro. Tentativa ${retryAttempt + 1}/3...`, 'warning');
                
                // Aguarda 2 segundos antes de iniciar novo processamento
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Inicia nova tentativa com as chaves que falharam
                return downloadAll(retryAttempt + 1, failedKeys);
            }

            isDownloading = false;
            document.getElementById('downloadProgress').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            downloadAllBtn.disabled = false;
            downloadAllBtn.innerHTML = '<i class="fas fa-download"></i> Baixar Todos os XMLs';

            const remainingCount = document.querySelectorAll('.url-button[style="display: none;"]').length;
            let message = `Processamento concluído: ${successCount} sucesso(s), ${failCount} falha(s)`;
            
            if (failedKeys.length > 0 && retryAttempt >= 3) {
                message += `. Máximo de tentativas atingido. ${failedKeys.length} chave(s) ainda com erro.`;
            } else if (remainingCount > 0) {
                message += `. Ainda restam ${remainingCount} chave(s) pendente(s).`;
            }
            
            updateGlobalStatus(
                message,
                remainingCount === 0 ? 'success' : 'warning'
            );
        }

        function cancelDownloads() {
            shouldCancelDownloads = true;
            document.getElementById('cancelBtn').disabled = true;
        }

        function openAllUrls() {
            const urlButtons = Array.from(document.querySelectorAll('.url-button'))
                .filter(btn => btn.style.display !== 'none');

            if (urlButtons.length === 0) {
                updateGlobalStatus('Não há URLs disponíveis para abrir', 'warning');
                return;
            }

            urlButtons.forEach(btn => {
                if (btn.href && btn.href !== '#') {
                    window.open(btn.href, '_blank');
                }
            });

            updateGlobalStatus(`${urlButtons.length} URL(s) abertas em novas abas`, 'success');
        }

        async function clearCache() {
            if (!confirm('Tem certeza que deseja limpar o cache? Todas as URLs salvas serão perdidas.')) {
                return;
            }

            try {
                const response = await fetch('/clear-cache', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    urlCache.clear();

                    document.querySelectorAll('.url-button').forEach(btn => {
                        btn.style.display = 'none';
                        btn.href = '#';
                    });

                    document.querySelectorAll('.status-cell').forEach(cell => {
                        cell.innerHTML = '<span class="text-muted">Aguardando processamento</span>';
                    });

                    updateGlobalStatus('Cache limpo com sucesso', 'success');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateGlobalStatus(`Erro ao limpar cache: ${error.message}`, 'danger');
            }
        }

        async function deleteKey(key) {
            if (!confirm('Tem certeza que deseja remover esta chave? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch('/delete-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ key: key }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateGlobalStatus(`Chave NFe ${key} removida com sucesso.`, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    updateGlobalStatus(`Erro ao remover chave NFe: ${data.message}`, 'danger');
                }
            } catch (error) {
                updateGlobalStatus(`Erro ao remover chave NFe: ${error.message}`, 'danger');
            }
        }

        async function deleteAllKeys() {
            // Get the number of keys to show in the confirmation
            const numKeys = document.querySelectorAll('.key-cell').length;
            
            if (numKeys === 0) {
                updateGlobalStatus('Não há chaves para remover', 'warning');
                return;
            }
            
            // Confirmation dialog with count of keys to be deleted
            if (!confirm(`Tem certeza que deseja remover TODAS as ${numKeys} chaves?\n\nEsta ação não pode ser desfeita e vai remover também todo o cache de URLs.`)) {
                return;
            }
            
            // Second confirmation for safety
            if (!confirm('ÚLTIMA CHANCE: Esta ação irá remover permanentemente todas as chaves NFe. Confirmar?')) {
                return;
            }
            
            // Visual feedback - disable button and show spinner
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            const originalBtnText = deleteAllBtn.innerHTML;
            deleteAllBtn.disabled = true;
            deleteAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removendo...';
            
            try {
                updateGlobalStatus('Removendo todas as chaves...', 'info');
                
                const response = await fetch('/delete-all-keys', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    updateGlobalStatus(`Todas as ${data.count} chaves foram removidas com sucesso`, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateGlobalStatus(`Erro ao remover todas as chaves: ${error.message}`, 'danger');
                // Restore button
                deleteAllBtn.disabled = false;
                deleteAllBtn.innerHTML = originalBtnText;
            }
        }

        function expandAllGroups() {
            const groups = document.querySelectorAll('.cnpj-group-header');
            groups.forEach(group => {
                const cnpj = group.getAttribute('data-cnpj');
                const icon = group.querySelector('.cnpj-toggle-icon');
                icon.classList.add('open');
                
                const groupRows = document.querySelectorAll(`tr.key-row[data-cnpj="${cnpj}"]`);
                groupRows.forEach(row => {
                    row.classList.remove('cnpj-group-hidden');
                });
            });
        }

        function collapseAllGroups() {
            const groups = document.querySelectorAll('.cnpj-group-header');
            groups.forEach(group => {
                const cnpj = group.getAttribute('data-cnpj');
                const icon = group.querySelector('.cnpj-toggle-icon');
                icon.classList.remove('open');
                
                const groupRows = document.querySelectorAll(`tr.key-row[data-cnpj="${cnpj}"]`);
                groupRows.forEach(row => {
                    row.classList.add('cnpj-group-hidden');
                });
            });
        }

        function clearCNPJFilter() {
            document.getElementById('cnpjFilter').value = '';
            filterKeys();
        }

        function clearDateFilter() {
            document.getElementById('dateFilter').value = '';
            filterKeys();
        }

        function filterKeys() {
            const cnpjFilter = document.getElementById('cnpjFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const keyRows = Array.from(document.querySelectorAll('.key-row'));
            const groupHeaders = Array.from(document.querySelectorAll('.cnpj-group-header'));
            
            // First, handle all key rows
            const cnpjMatches = new Set(); // Keep track of which CNPJs match the filter
            
            keyRows.forEach(keyRow => {
                const cnpjCell = keyRow.querySelector('.cnpj-cell');
                const anoMesCell = keyRow.querySelector('.ano-mes-cell');
                const cnpj = cnpjCell.textContent;
                const anoMes = anoMesCell.textContent.trim();
                
                // Check if row matches both filters
                const cnpjMatch = !cnpjFilter || cnpj === cnpjFilter;
                const dateMatch = !dateFilter || anoMes === dateFilter;
                
                if (cnpjMatch && dateMatch) {
                    // This row matches both filters
                    keyRow.style.display = 'table-row';
                    keyRow.classList.remove('cnpj-group-hidden'); // Make sure it's visible even if group is collapsed
                    cnpjMatches.add(keyRow.getAttribute('data-cnpj')); // Mark this CNPJ as having matches
                } else {
                    // This row doesn't match one or both filters
                    keyRow.style.display = 'none';
                }
            });
            
            // Then handle group headers - only show headers for groups that have matches
            groupHeaders.forEach(header => {
                const cnpj = header.getAttribute('data-cnpj');
                if (cnpjMatches.has(cnpj) || (!cnpjFilter && !dateFilter)) {
                    header.style.display = 'table-row';
                    
                    // If filtering, ensure the toggle icon shows as expanded
                    if (cnpjFilter || dateFilter) {
                        const icon = header.querySelector('.cnpj-toggle-icon');
                        icon.classList.add('open');
                    }
                } else {
                    header.style.display = 'none';
                }
            });
            
            // Update UI based on filter results
            if (!cnpjFilter && !dateFilter) {
                // No filters - show normal count
                document.getElementById('totalKeysCount').textContent = keyRows.length;
            } else {
                // Show filtered count
                const visibleCount = keyRows.filter(row => row.style.display !== 'none').length;
                document.getElementById('totalKeysCount').textContent = `${visibleCount} (filtrados)`;
            }
        }
    </script>
</body>
</html> 
